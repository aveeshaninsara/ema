<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar - Elephant Monitoring</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body, html {margin:0; padding:0; height:100%; font-family:Roboto,sans-serif;}
#map {width:100%; height:100vh;}
#controls {position:absolute; top:10px; left:10px; z-index:1000; background:white; padding:10px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.2);}
#controls select, #controls button {margin-top:5px; margin-bottom:5px;}
header {width:100%; position:fixed; top:0; z-index:999; background:#2e7d32; color:white; padding:12px 16px; text-align:center; font-size:1.5rem; font-weight:bold; box-shadow:0 4px 8px rgba(0,0,0,0.2);}
</style>
</head>
<body>
<header>Elephant Radar</header>
<div id="controls">
  <select id="categorySelect">
    <option value="all">All Reports</option>
    <option value="accidents">Accidents</option>
    <option value="sightings">Sightings</option>
  </select>
  <button id="toggleMap" class="btn green">Toggle Map</button>
</div>
<div id="map"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map = L.map('map', {zoomControl:true, maxZoom:19}).setView([7.8731, 80.7718], 7);

let normalMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});

document.addEventListener("DOMContentLoaded",()=>{let elems=document.querySelectorAll('select');M.FormSelect.init(elems);});

const icons = {
  accident: L.icon({iconUrl:'https://i.ibb.co/BnJ3cDQ/blue-marker.png', iconSize:[32,32]}),
  low: L.icon({iconUrl:'https://i.ibb.co/2W7h7V0/green-marker.png', iconSize:[32,32]}),
  medium: L.icon({iconUrl:'https://i.ibb.co/TY8VsK4/yellow-marker.png', iconSize:[32,32]}),
  high: L.icon({iconUrl:'https://i.ibb.co/tswMbyQ/red-marker.png', iconSize:[32,32]})
};

let markers = [];

function clearMarkers(){markers.forEach(m=>map.removeLayer(m)); markers=[];}

async function loadMarkers(category='all'){
  clearMarkers();
  const snapshot = await get(child(ref(db),'reports'));
  if(snapshot.exists()){
    snapshot.forEach(snap=>{
      const data = snap.val();
      const type = data.type;
      const danger = data.danger;
      if(category!=='all' && category!==type) return;
      let icon = icons.accident;
      if(type==='sighting'){
        if(danger==='low') icon=icons.low;
        else if(danger==='medium') icon=icons.medium;
        else if(danger==='high') icon=icons.high;
      }
      const m = L.marker([data.lat,data.lng],{icon}).addTo(map);
      m.bindPopup(`<b>${type.toUpperCase()}</b><br>Danger: ${danger||'N/A'}<br>Details: ${data.details||'No details'}`);
      markers.push(m);
    });
  }
}

document.getElementById('categorySelect').addEventListener('change', e=>{
  loadMarkers(e.target.value);
});

document.getElementById('toggleMap').addEventListener('click',()=>{
  if(map.hasLayer(normalMap)){map.removeLayer(normalMap); map.addLayer(satelliteMap);}
  else {map.removeLayer(satelliteMap); map.addLayer(normalMap);}
});

loadMarkers();

function refreshMarkers(){loadMarkers(document.getElementById('categorySelect').value);}
setInterval(refreshMarkers, 5000);

</script>
<script>
if("serviceWorker"in navigator){navigator.serviceWorker.register("service-worker.js").then(()=>console.log("SW registered"));}
</script>
</body>
</html>
