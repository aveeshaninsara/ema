<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar - Elephant Monitoring App</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body{font-family:Roboto,sans-serif;margin:0;padding:0;background:#f4f4f4;}
#map{height:100vh;width:100%;}
#notification{position:fixed;top:20px;right:20px;background:#2e7d32;color:white;padding:12px 20px;border-radius:12px;display:none;z-index:1000;}
#settingsPanel{position:fixed;top:0;right:-300px;width:300px;height:100%;background:white;box-shadow:-4px 0 12px rgba(0,0,0,0.3);transition:0.3s;padding:15px;z-index:999;}
#settingsPanel.open{right:0;}
.settingsBtn{position:fixed;top:20px;right:20px;font-size:24px;z-index:1001;color:#2e7d32;cursor:pointer;}
.modal img{width:100%;border-radius:8px;margin-bottom:10px;}
</style>
</head>
<body>
<div id="map"></div>
<div id="notification"></div>
<i class="fas fa-cog settingsBtn" id="settingsBtn"></i>
<div id="settingsPanel">
<h5>Settings</h5>
<p>Notification Radius (meters)</p>
<input type="number" id="notifRadiusInput" value="1000"/>
<p>
<label><input type="checkbox" id="alertSound"/><span>Sound on Alert</span></label>
</p>
<p>
<label><input type="checkbox" id="bgAlert"/><span>Background Alerts</span></label>
</p>
</div>
<div id="imagesModal" class="modal">
<div class="modal-content"><h5>Report Images</h5><div id="imagesContainer"></div></div>
<div class="modal-footer"><a href="#!" class="modal-close btn grey">Close</a></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.appspot.com",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let map = L.map('map').setView([7.8731,80.7718],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let userMarker=null, sightingMarkers=L.layerGroup().addTo(map), accidentMarkers=L.layerGroup().addTo(map);
let notifRadius=parseInt(document.getElementById("notifRadiusInput").value);
let alertSound=document.getElementById("alertSound").checked, bgAlert=document.getElementById("bgAlert").checked;
document.getElementById("settingsBtn").addEventListener("click",()=>{document.getElementById("settingsPanel").classList.toggle("open");});
document.getElementById("notifRadiusInput").addEventListener("input",()=>{notifRadius=parseInt(document.getElementById("notifRadiusInput").value);});
document.getElementById("alertSound").addEventListener("change",()=>{alertSound=document.getElementById("alertSound").checked;});
document.getElementById("bgAlert").addEventListener("change",()=>{bgAlert=document.getElementById("bgAlert").checked;});
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}
function sendAlertNotification(msg){if(navigator.serviceWorker.controller){navigator.serviceWorker.controller.postMessage({type:'ALERT',message:msg});}}
function showNotification(msg){const n=document.getElementById("notification");n.textContent=msg;n.style.display="block";setTimeout(()=>{n.style.display="none";},3000);if(alertSound)new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3').play();}
async function loadReports(){
  const snap=await get(ref(db,"reports"));
  if(!snap.exists())return;
  const data=snap.val();
  Object.entries(data).forEach(([type,reports])=>{
    Object.entries(reports).forEach(([id,report])=>{
      const marker=L.marker([report.lat,report.lng]).addTo(type==="sightings"?sightingMarkers:accidentMarkers);
      marker.bindPopup(`<b>${type.toUpperCase()}</b><br>${report.district||"Unknown"}<br><button class="imageBtn btn blue" data-images='${JSON.stringify(report.images||{})}'>Images</button><button class="falseBtn btn red">False Info</button>`);
      marker.on('popupopen',()=>{marker.getPopup().getElement().querySelector(".imageBtn").onclick=()=>{const imgs=JSON.parse(marker.getPopup().getElement().querySelector(".imageBtn").getAttribute("data-images"));const container=document.getElementById("imagesContainer");container.innerHTML="";Object.values(imgs).forEach(img=>{const el=document.createElement("img");el.src=img;container.appendChild(el);});M.Modal.getInstance(document.getElementById("imagesModal")).open();};marker.getPopup().getElement().querySelector(".falseBtn").onclick=()=>{showNotification("Reported as false info","red");};});
    });
  });
}
function trackUser(){navigator.geolocation.watchPosition(pos=>{const lat=pos.coords.latitude,lng=pos.coords.longitude;if(userMarker)map.removeLayer(userMarker);userMarker=L.marker([lat,lng],{icon:L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",iconSize:[32,32]})}).addTo(map);map.setView([lat,lng],13);checkNearbyAlerts(lat,lng);},err=>{showNotification("Unable to get location","red");});}
function checkNearbyAlerts(lat,lng){
  [sightingMarkers,accidentMarkers].forEach(layerGroup=>{
    layerGroup.eachLayer(marker=>{
      if(marker.getLatLng){
        const d=map.distance([lat,lng],marker.getLatLng());
        if(d<=notifRadius){showNotification("Elephant alert nearby!");if(bgAlert)sendAlertNotification("Elephant nearby at "+marker.getLatLng().lat.toFixed(4)+","+marker.getLatLng().lng.toFixed(4));}
      }
    });
  });
}
loadReports();trackUser();
</script>
</body>
</html>
