<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMA Radar</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body{margin:0;padding:0;height:100%;width:100%;font-family:sans-serif;}
#map{height:100%;width:100%;}
#controls{position:absolute;top:10px;left:10px;z-index:1000;background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
#settingsPanel{position:absolute;top:10px;right:10px;z-index:1000;background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:none;}
button,select,input{margin:5px 0;padding:5px;}
</style>
</head>
<body>
<div id="map"></div>

<div id="controls">
  <select id="reportType">
    <option value="sightings">Sightings</option>
    <option value="accidents">Accidents</option>
  </select>
  <button id="toggleMap">Satellite View</button>
  <button id="openSettings">Settings</button>
</div>

<div id="settingsPanel">
  <label>Notification radius (meters)</label><br>
  <input type="number" id="notifRadiusInput" value="500"><br>
  <button id="closeSettings">Close Settings</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
// Firebase setup
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, set, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.appspot.com",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Map setup
let terrainLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
let satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

let map = L.map('map', {layers:[terrainLayer]}).setView([7.8731, 80.7718], 7);

let reportMarkers=[], reportCircles=[];
let reportTypeSelect = document.getElementById('reportType');
let notifRadiusInput = document.getElementById('notifRadiusInput');
let notifRadius = parseInt(localStorage.getItem('notifRadius')||500);

function reportFalse(key){
  const val = prompt("Reason for false report?");
  if(val){
    push(ref(db,'falseonmap'),{reportKey:key, reason:val, time:new Date().toLocaleString()});
    alert("We'll take necessary actions. Stay updated.");
  }
}

function loadReports(){
  reportMarkers.forEach(m=>map.removeLayer(m));
  reportCircles.forEach(c=>map.removeLayer(c));
  reportMarkers=[]; reportCircles=[];
  const type = reportTypeSelect.value;
  const now = new Date();

  if(type==='sightings'){
    onValue(ref(db,'reports'), snapshot=>{
      snapshot.forEach(snap=>{
        const data = snap.val();
        if(!data.elephant) return;
        const reportTime = new Date(data.time);
        if((now-reportTime)/3600000>24) return;
        const lat=data.lat,lng=data.lng;
        const m = L.marker([lat,lng],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/616/616408.png',iconSize:[25,25]})}).addTo(map);
        const circle = L.circle([lat,lng],{radius:notifRadius,color:'blue',fillOpacity:0.1}).addTo(map);
        reportMarkers.push(m); reportCircles.push(circle);
        m.bindPopup(`<b>Elephant Sighting</b><br>District: ${data.district || ''}<br>Description: ${data.description || ''}<br>Number: ${data.numElephants || ''}<br><button onclick="reportFalse('${snap.key}')">False information reported!</button>`);
      });
    });
  } else if(type==='accidents'){
    onValue(ref(db,'accidents'), snapshot=>{
      snapshot.forEach(snap=>{
        const data = snap.val();
        const reportTime = new Date(data.time);
        if((now-reportTime)/3600000>24) return;
        const lat=data.lat,lng=data.lng;
        const m = L.marker([lat,lng],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/565/565491.png',iconSize:[25,25]})}).addTo(map);
        reportMarkers.push(m);
        m.bindPopup(`<b>Elephant Accident</b><br>District: ${data.district || ''}<br>Description: ${data.description || ''}<br><button onclick="reportFalse('${snap.key}')">False information reported!</button>`);
      });
    });
  }
}

reportTypeSelect.addEventListener('change',loadReports);
loadReports();

// Map toggle
let satellite=false;
document.getElementById('toggleMap').addEventListener('click',()=>{
  if(satellite){map.removeLayer(satelliteLayer);terrainLayer.addTo(map);document.getElementById('toggleMap').textContent='Satellite View';}
  else{map.removeLayer(terrainLayer);satelliteLayer.addTo(map);document.getElementById('toggleMap').textContent='Normal View';}
  satellite=!satellite;
});

// User location with reverse geolocation
map.locate({setView:true,watch:true});
map.on('locationfound', e=>{
  L.marker([e.latitude,e.longitude]).addTo(map).bindPopup("You are here").openPopup();
});

// Settings panel
document.getElementById('openSettings').addEventListener('click',()=>{document.getElementById('settingsPanel').style.display='block';});
document.getElementById('closeSettings').addEventListener('click',()=>{
  document.getElementById('settingsPanel').style.display='none';
  notifRadius=parseInt(notifRadiusInput.value);
  localStorage.setItem('notifRadius',notifRadius);
  loadReports();
});

// Background notifications using Service Worker
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}
</script>

<script>
// Service Worker for notifications
const swCode = `
self.addEventListener('install', e=>{self.skipWaiting();});
self.addEventListener('activate', e=>{self.clients.claim();});
self.addEventListener('push', e=>{
  const data = e.data.json();
  self.registration.showNotification(data.title,{body:data.body,icon:data.icon});
});
`;
const blob = new Blob([swCode],{type:'application/javascript'});
const url = URL.createObjectURL(blob);
navigator.serviceWorker.register(url);
</script>
</body>
</html>
