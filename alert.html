<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alerts - Elephant Monitoring App</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family: Roboto, sans-serif; margin:0; background:#fafafa; }
.card { margin:10px auto; padding:10px; border-radius:12px; max-width:480px; }
.card-content p { margin:4px 0; }
.expand-btn { cursor:pointer; }
.action-icons i { cursor:pointer; margin-right:10px; }
#filterSection { display:flex; justify-content:space-between; align-items:center; margin:10px; flex-wrap:wrap; }
</style>
</head>
<body>

<div id="filterSection">
  <select id="districtFilter">
    <option value="">All Districts</option>
  </select>
  <select id="typeFilter">
    <option value="sightings">Sightings</option>
    <option value="accidents">Accidents</option>
  </select>
  <a id="btnWhyNotShow" class="btn orange">Why is my report not showing?</a>
  <a href="home.html" class="btn green">Home</a>
</div>

<div id="reportsContainer"></div>

<div id="deletedReportsContainer" style="display:none;"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, child, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function getCookie(name){
  let m=document.cookie.match("(^|;)\\s*"+name+"\\s*=\\s*([^;]+)");
  return m?m.pop():"";
}
const userId = getCookie("emaId");
if(!userId){window.location.href="index.html"; return;}

const districts = [
  "Ampara","Anuradhapura","Badulla","Batticaloa","Colombo","Galle","Gampaha","Hambantota","Jaffna","Kalutara","Kandy","Kegalle","Kilinochchi","Kurunegala","Mannar","Matale","Matara","Monaragala","Mullaitivu","Nuwara Eliya","Polonnaruwa","Puttalam","Ratnapura","Trincomalee","Vavuniya"
];
const districtSelect = document.getElementById("districtFilter");
districts.forEach(d => {
  let opt = document.createElement("option");
  opt.value = d; opt.textContent = d;
  districtSelect.appendChild(opt);
});

let currentAgent = null;
await get(child(ref(db), "users/" + userId)).then(snap => {
  if(snap.exists()){
    const u = snap.val();
    if(u.agentId) currentAgent = u;
  }
});

const reportsContainer = document.getElementById("reportsContainer");
const deletedContainer = document.getElementById("deletedReportsContainer");

async function loadReports(){
  reportsContainer.innerHTML = "";
  const type = document.getElementById("typeFilter").value;
  const districtFilter = document.getElementById("districtFilter").value;
  await get(child(ref(db), "reports/" + type)).then(snap => {
    if(snap.exists()){
      const now = new Date();
      const data = snap.val();
      Object.entries(data).forEach(([id, r]) => {
        const reportTime = new Date(r.time);
        if(now - reportTime > 24*60*60*1000) return;
        if(districtFilter && r.district !== districtFilter) return;

        const card = document.createElement("div"); card.className = "card";
        card.innerHTML = `
          <span class="expand-btn"><strong>${type.toUpperCase()}</strong> - ${r.district}</span>
          <div class="card-content" style="display:none;">
            <p><strong>Reporter:</strong> ${r.userName}</p>
            <p><strong>Mobile:</strong> <a href="tel:${r.userMobile}">${r.userMobile}</a></p>
            <p><strong>Description:</strong> ${r.description}</p>
            <p><strong>Danger Level:</strong> ${r.dangerLevel || 'N/A'}</p>
            <div class="action-icons">
              <i class="material-icons map-icon">map</i>
              <i class="material-icons image-icon">image</i>
              ${currentAgent && currentAgent.agentId && currentAgent.district === r.district ? '<i class="material-icons delete-icon red-text">delete</i>' : ''}
            </div>
          </div>`;
        reportsContainer.appendChild(card);

        const expandBtn = card.querySelector(".expand-btn");
        const contentDiv = card.querySelector(".card-content");
        expandBtn.addEventListener("click", ()=>{contentDiv.style.display = contentDiv.style.display==="none"?"block":"none";});

        card.querySelector(".map-icon").addEventListener("click", ()=>{alert(`Map: Lat ${r.lat}, Lng ${r.lng}`);});
        card.querySelector(".image-icon").addEventListener("click", ()=>{alert(`Images: ${r.images || 'No Images'}`);});

        const deleteBtn = card.querySelector(".delete-icon");
        if(deleteBtn){
          deleteBtn.addEventListener("click", async ()=>{
            const reason = prompt("Reason for deletion (fake report, miscontent, fraud info, duplicate, other):");
            if(!reason) return;
            const agentName = currentAgent.name;
            const agentId = currentAgent.agentId;
            const district = currentAgent.district;
            if(r.district !== district) { alert("You cannot delete reports outside your district."); return;}
            await remove(ref(db, `reports/${type}/${id}`));
            await update(ref(db, `deletedreportinfo/${r.userId}/${id}`), {
              deletedByName: agentName,
              deletedById: agentId,
              reason,
              deletedAt: new Date().toLocaleString()
            });
            alert("Report deleted successfully.");
            loadReports();
          });
        }
      });
    }
  });
}

document.getElementById("typeFilter").addEventListener("change", loadReports);
document.getElementById("districtFilter").addEventListener("change", loadReports);
document.getElementById("btnWhyNotShow").addEventListener("click", ()=>{
  reportsContainer.style.display="none";
  deletedContainer.style.display="block";
  deletedContainer.innerHTML="<h5>Deleted Reports</h5>";
  get(ref(db,"deletedreportinfo")).then(snap=>{
    if(snap.exists()){
      const data = snap.val();
      Object.entries(data).forEach(([uid, reports])=>{
        Object.entries(reports).forEach(([rid,r])=>{
          const card = document.createElement("div"); card.className="card";
          card.innerHTML = `
            <p><strong>Deleted Report ID:</strong> ${rid}</p>
            <p><strong>Deleted By:</strong> ${r.deletedByName} (${r.deletedById})</p>
            <p><strong>Reason:</strong> ${r.reason}</p>
            <p><strong>Deleted At:</strong> ${r.deletedAt}</p>
            <p><strong>Reporter User ID:</strong> ${uid}</p>
            <p><strong>Contact:</strong> <a href="#" class="copyMobile">${r.deletedById}</a></p>
          `;
          deletedContainer.appendChild(card);
          card.querySelector(".copyMobile").addEventListener("click", e=>{
            navigator.clipboard.writeText(r.deletedById);
            alert("Copied to clipboard");
          });
        });
      });
    }
  });
});

loadReports();

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
