<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alerts - Elephant Monitoring App</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family: Roboto, sans-serif; background:#fafafa; margin:0; padding:0; }
.container { padding:10px; max-width:480px; margin:auto; }
.card { margin:10px 0; border-radius:12px; }
.card-content p { margin:4px 0; }
.card-actions { display:flex; justify-content:space-between; }
.icon-btn { cursor:pointer; color:#1976d2; }
.icon-btn.delete { color:red; }
#filterSection { display:flex; justify-content:space-between; margin-bottom:10px; flex-wrap:wrap; }
#filterSection select, #filterSection button { flex:1; margin:4px; }
.modal { max-width:400px; }
</style>
</head>
<body>

<div class="container">
  <div id="filterSection">
    <select id="filterType">
      <option value="sightings">Sightings</option>
      <option value="accidents">Accidents</option>
    </select>
    <select id="filterDistrict">
      <option value="All">All Districts</option>
    </select>
    <button id="btnWhy" class="btn orange">Why is my report not showing?</button>
    <button id="btnHome" class="btn green">Home</button>
  </div>

  <div id="reportsContainer"></div>
</div>

<div id="imageModal" class="modal">
  <div class="modal-content" id="imageModalContent"></div>
  <div class="modal-footer"><a href="#!" class="modal-close btn red">Close</a></div>
</div>

<div id="mapModal" class="modal">
  <div class="modal-content" id="mapModalContent" style="height:400px;"></div>
  <div class="modal-footer"><a href="#!" class="modal-close btn red">Close</a></div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h5>Delete Report</h5>
    <div class="input-field">
      <select id="deleteReason">
        <option value="" disabled selected>Reason</option>
        <option value="Fake report">Fake report</option>
        <option value="Miscontent">Miscontent</option>
        <option value="Fraud information">Fraud information</option>
        <option value="Description is fake">Description is fake</option>
        <option value="Duplicate report">Duplicate report</option>
        <option value="Other">Other</option>
      </select>
      <label>Reason for deletion</label>
    </div>
    <div class="input-field">
      <input type="password" id="agentPassword" />
      <label>Enter Agent Password</label>
    </div>
    <p>
      <label>
        <input type="checkbox" id="deleteAgreement" />
        <span>I agree this information is correct and will not harass anyone</span>
      </label>
    </p>
  </div>
  <div class="modal-footer">
    <a href="#!" id="confirmDelete" class="btn red">Delete</a>
  </div>
</div>

<div id="whyModal" class="modal">
  <div class="modal-content">
    <h5>Deleted Reports</h5>
    <div id="deletedContainer"></div>
  </div>
  <div class="modal-footer"><a href="#!" class="modal-close btn red">Close</a></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, child, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

document.addEventListener("DOMContentLoaded", async ()=>{
  const districts=["Ampara","Anuradhapura","Badulla","Batticaloa","Colombo","Galle","Gampaha","Hambantota","Jaffna","Kalutara","Kandy","Kegalle","Kilinochchi","Kurunegala","Mannar","Matale","Matara","Monaragala","Mullaitivu","Nuwara Eliya","Polonnaruwa","Puttalam","Ratnapura","Trincomalee","Vavuniya"];
  const filterDistrict=document.getElementById("filterDistrict");
  districts.forEach(d=>{
    let opt=document.createElement("option");
    opt.value=d; opt.textContent=d;
    filterDistrict.appendChild(opt);
  });
  const Mscript = document.createElement("script");
  Mscript.src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js";
  document.body.appendChild(Mscript);
  Mscript.onload = ()=>{
    M.FormSelect.init(document.querySelectorAll('select'));
    M.Modal.init(document.querySelectorAll('.modal'));
  };

  function getCookie(name){ let m=document.cookie.match("(^|;)\\s*"+name+"\\s*=\\s*([^;]+)"); return m?m.pop():"";}
  const userId=getCookie("emaId");
  if(!userId){ window.location.href="index.html"; return;}
  const userSnap = await get(child(ref(db), "users/"+userId));
  if(!userSnap.exists()) return;
  const user=userSnap.val();
  const isAgent = user.role==="agent";

  const reportsContainer=document.getElementById("reportsContainer");

  async function loadReports(){
    reportsContainer.innerHTML="";
    const type=document.getElementById("filterType").value;
    const districtFilter=document.getElementById("filterDistrict").value;
    const reportsSnap = await get(child(ref(db), "reports/"+type));
    if(!reportsSnap.exists()) return;
    const now=new Date().getTime();
    Object.entries(reportsSnap.val()).forEach(([key, report])=>{
      const reportTime=new Date(report.time).getTime();
      if(now-reportTime>24*60*60*1000) return;
      if(districtFilter!=="All" && report.district!==districtFilter) return;

      const card=document.createElement("div"); card.className="card";
      let html=`<div class="card-content">
        <span class="card-title">${report.description}</span>
        <p>Reporter: ${report.userName} | Mobile: <a href="tel:${report.userMobile}">${report.userMobile}</a></p>
        <p>District: ${report.district} | Elephants: ${report.numElephants} | Danger: ${report.dangerLevel}</p>
        <div class="card-actions">
          <i class="material-icons icon-btn" data-lat="${report.lat}" data-lng="${report.lng}">map</i>
          <i class="material-icons icon-btn" data-images='${JSON.stringify(report.images || [])}'>image</i>
          ${isAgent? `<i class="material-icons icon-btn delete" data-key="${key}" data-type="${type}" data-userid="${report.userId}">delete</i>` : ''}
        </div></div>`;
      card.innerHTML=html;
      reportsContainer.appendChild(card);
    });

    document.querySelectorAll(".icon-btn").forEach(btn=>{
      if(btn.textContent==="map"){
        btn.onclick=()=>{
          const lat=parseFloat(btn.dataset.lat), lng=parseFloat(btn.dataset.lng);
          const mapDiv=document.getElementById("mapModalContent"); mapDiv.innerHTML="";
          const iframe=document.createElement("iframe");
          iframe.style.width="100%"; iframe.style.height="400px";
          iframe.src=`https://www.google.com/maps?q=${lat},${lng}&hl=es;z=14&output=embed`;
          mapDiv.appendChild(iframe);
          M.Modal.getInstance(document.getElementById("mapModal")).open();
        }
      } else if(btn.textContent==="image"){
        btn.onclick=()=>{
          const images=JSON.parse(btn.dataset.images);
          const modalContent=document.getElementById("imageModalContent"); modalContent.innerHTML="";
          images.forEach(src=>{
            const img=document.createElement("img"); img.src=src; img.style.width="100%"; img.style.marginBottom="5px";
            modalContent.appendChild(img);
          });
          M.Modal.getInstance(document.getElementById("imageModal")).open();
        }
      } else if(btn.classList.contains("delete")){
        btn.onclick=()=>{
          const key=btn.dataset.key, type=btn.dataset.type, reportUserId=btn.dataset.userid;
          const deleteModal=M.Modal.getInstance(document.getElementById("deleteModal"));
          deleteModal.open();
          document.getElementById("confirmDelete").onclick=async ()=>{
            const reason=document.getElementById("deleteReason").value;
            const agreement=document.getElementById("deleteAgreement").checked;
            const password=document.getElementById("agentPassword").value;
            if(!reason || !agreement || !password) return alert("Fill all fields and agree.");
            const validPass = user.password; 
            if(password!==validPass) return alert("Invalid agent password!");
            await update(ref(db,"deletedreportinfo/"+reportUserId+"/"+key),{deletedBy:user.name, agentId:user.agentId, reason, time:new Date().toLocaleString(), type});
            await remove(ref(db,"reports/"+type+"/"+key));
            deleteModal.close();
            loadReports();
          }
        }
      }
    });
  }

  document.getElementById("filterType").onchange=loadReports;
  document.getElementById("filterDistrict").onchange=loadReports;
  document.getElementById("btnHome").onclick=()=>{ window.location.href="home.html"; };
  document.getElementById("btnWhy").onclick=async ()=>{
    const deletedModal=M.Modal.getInstance(document.getElementById("whyModal"));
    const deletedContainer=document.getElementById("deletedContainer");
    deletedContainer.innerHTML="";
    const deletedSnap=await get(ref(db,"deletedreportinfo"));
    if(deletedSnap.exists()){
      Object.entries(deletedSnap.val()).forEach(([uid, reports])=>{
        Object.entries(reports).forEach(([rid, rinfo])=>{
          const card=document.createElement("div"); card.className="card";
          card.innerHTML=`<div class="card-content">
            <p>Original Reporter ID: ${uid}</p>
            <p>Deleted By: ${rinfo.deletedBy} | Agent ID: ${rinfo.agentId} | Reason: ${rinfo.reason}</p>
            <p>Time: ${rinfo.time}</p>
            <p>Agent Mobile: <a href="tel:${rinfo.agentMobile || ''}">${rinfo.agentMobile || 'N/A'}</a></p>
          </div>`;
          deletedContainer.appendChild(card);
        });
      });
    }
    deletedModal.open();
  };

  loadReports();
});
</script>
</body>
</html>
