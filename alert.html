<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elephant Alerts</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<style>
body { font-family: Roboto, sans-serif; margin:0; padding:0; background:#f0f0f0; }
.header { display:flex; justify-content:space-between; align-items:center; padding:12px; background:#2e7d32; color:white; }
.header h5 { margin:0; }
.btn-container { display:flex; gap:12px; margin:12px; flex-wrap:wrap; }
.card-report { margin:12px auto; max-width:480px; border-radius:12px; overflow:hidden; background:white; cursor:pointer; }
.card-content { padding:12px; }
.card-header { display:flex; justify-content:space-between; align-items:center; }
.card-footer { display:flex; justify-content:flex-end; gap:12px; padding:12px; }
.map-popup, .images-popup { width:300px; height:200px; }
.hidden { display:none; }
</style>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, update, child, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window._fb = { db, ref, get, update, child, remove };
</script>
</head>
<body>
<div class="header">
<h5>Elephant Alerts</h5>
<div>
<a href="home.html" class="btn green">Home</a>
<a id="btnDeletedReports" class="btn orange">Why is my report not showing?</a>
</div>
</div>
<div class="btn-container">
<select id="filterType">
<option value="all">All Reports</option>
<option value="sightings">Sightings</option>
<option value="accidents">Accidents</option>
</select>
<select id="filterDistrict">
<option value="all">All Districts</option>
</select>
</div>
<div id="reportsContainer"></div>
<div id="deletedContainer" class="hidden"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  M.FormSelect.init(document.querySelectorAll('select'));
  const districts = ["Ampara","Anuradhapura","Badulla","Batticaloa","Colombo","Galle","Gampaha","Hambantota","Jaffna","Kalutara","Kandy","Kegalle","Kilinochchi","Kurunegala","Mannar","Matale","Matara","Monaragala","Mullaitivu","Nuwara Eliya","Polonnaruwa","Puttalam","Ratnapura","Trincomalee","Vavuniya"];
  const districtSelect = document.getElementById("filterDistrict");
  districts.forEach(d => { let opt=document.createElement("option"); opt.value=d; opt.textContent=d; districtSelect.appendChild(opt); });
  M.FormSelect.init(document.querySelectorAll('select'));

  const getCookie = name => document.cookie.split('; ').find(r => r.startsWith(name+'='))?.split('=')[1] || '';
  const userId = getCookie("emaId");
  if(!userId){ window.location.href="index.html"; return; }

  const userSnap = await get(child(ref(db), "users/"+userId));
  const userData = userSnap.exists()? userSnap.val() : null;
  const isAgent = userData?.agentId;
  const agentDistrict = userData?.district;

  const reportsContainer = document.getElementById("reportsContainer");
  const deletedContainer = document.getElementById("deletedContainer");
  const filterType = document.getElementById("filterType");
  const filterDistrict = document.getElementById("filterDistrict");

  async function loadReports(){
    reportsContainer.innerHTML='';
    const allReportsSnap = await get(ref(db,"reports"));
    const now = new Date();
    if(!allReportsSnap.exists()) return;
    const types = ["sightings","accidents"];
    for(const t of types){
      if(filterType.value!=="all" && filterType.value!==t) continue;
      const typeSnap = allReportsSnap.child(t);
      if(!typeSnap.exists()) continue;
      const reports = typeSnap.val();
      for(const rKey in reports){
        const r = reports[rKey];
        if(new Date(r.time) < now - 24*60*60*1000) continue;
        if(filterDistrict.value!=="all" && r.district!==filterDistrict.value) continue;
        const card = document.createElement("div");
        card.className="card-report";
        card.innerHTML=`
        <div class="card-content">
          <div class="card-header">
            <span><b>${t.toUpperCase()}</b> - ${r.district}</span>
            ${isAgent && agentDistrict===r.district ? '<a href="#!" class="btn red btnDelete">Delete</a>' : ''}
          </div>
          <p><b>Reporter:</b> ${r.userName} (${r.userMobile})</p>
          <p><b>Elephants:</b> ${r.numElephants}</p>
          <p><b>Danger:</b> ${r.dangerLevel}</p>
          <p><b>Description:</b> ${r.description}</p>
          <div class="card-footer">
            <a href="#!" class="btn-small blue btnMap">Map</a>
            <a href="#!" class="btn-small green btnImages">Images</a>
            <a href="#!" class="btn-small orange btnPDF">PDF</a>
          </div>
        </div>`;
        reportsContainer.appendChild(card);

        const btnMap = card.querySelector(".btnMap");
        btnMap.addEventListener("click",()=>{ 
          const mapDiv = document.createElement("div"); mapDiv.style.width="300px"; mapDiv.style.height="200px";
          const mapWin = window.open("", "_blank", "width=320,height=240"); mapWin.document.body.appendChild(mapDiv);
          const map = L.map(mapDiv).setView([r.lat,r.lng],13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
          L.marker([r.lat,r.lng]).addTo(map);
        });

        const btnImages = card.querySelector(".btnImages");
        btnImages.addEventListener("click",()=>{
          const imgWin = window.open("", "_blank","width=400,height=400");
          if(r.images){ r.images.forEach(src=>{ const i=document.createElement("img"); i.src=src; i.style.width="100%"; i.style.marginBottom="8px"; imgWin.document.body.appendChild(i); }); }
        });

        const btnPDF = card.querySelector(".btnPDF");
        btnPDF.addEventListener("click",()=>{
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFontSize(12); doc.text("Report PDF",10,10);
          doc.text(`Type: ${t}`,10,20);
          doc.text(`District: ${r.district}`,10,30);
          doc.text(`Reporter: ${r.userName} (${r.userMobile})`,10,40);
          doc.text(`Elephants: ${r.numElephants}`,10,50);
          doc.text(`Danger: ${r.dangerLevel}`,10,60);
          doc.text(`Description: ${r.description}`,10,70);
          doc.text(`Time: ${r.time}`,10,80);
          doc.save("report.pdf");
        });

        if(isAgent && agentDistrict===r.district){
          const btnDel = card.querySelector(".btnDelete");
          btnDel.addEventListener("click",async()=>{
            const reason = prompt("Reason for deletion: fake report, miscontent, fraud information, description is fake, duplicate report, other");
            if(!reason) return;
            const agentName = userData.name || "Unknown";
            const agentId = userData.agentId;
            const deletedInfo = { reason, agentName, agentId, time:new Date().toString() };
            await update(ref(db,`deletedreportinfo/${r.userId}/${rKey}`), deletedInfo);
            await remove(ref(db,`reports/${t}/${rKey}`));
            alert("Report deleted!");
            loadReports();
          });
        }
      }
    }
  }

  document.getElementById("btnDeletedReports").addEventListener("click", async ()=>{
    reportsContainer.innerHTML=''; deletedContainer.innerHTML=''; deletedContainer.classList.remove("hidden");
    const delSnap = await get(ref(db,"deletedreportinfo"));
    if(!delSnap.exists()) return;
    const delData = delSnap.val();
    for(const uid in delData){
      for(const repId in delData[uid]){
        const d = delData[uid][repId];
        const card = document.createElement("div");
        card.className="card-report";
        card.innerHTML=`
          <div class="card-content">
            <p><b>Reporter ID:</b> ${uid}</p>
            <p><b>Deleted by:</b> ${d.agentName} (${d.agentId})</p>
            <p><b>Reason:</b> ${d.reason}</p>
            <p><b>Time:</b> ${d.time}</p>
            <p><b>Mobile:</b> <span class="callNumber">${userData.userMobile || 'N/A'}</span></p>
          </div>`;
        deletedContainer.appendChild(card);
      }
    }
    document.querySelectorAll(".callNumber").forEach(el=>{
      el.addEventListener("click",()=>{ navigator.clipboard.writeText(el.textContent); alert("Number copied!"); });
    });
  });

  filterType.addEventListener("change", loadReports);
  filterDistrict.addEventListener("change", loadReports);
  loadReports();
});
</script>
</body>
</html>
