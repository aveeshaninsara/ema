<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elephant Alerts</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { background:#f4f4f4; }
    nav { background:#2e7d32; }
    .card { border-radius:12px; margin-bottom:20px; }
    .card-content img { width:100px; height:100px; object-fit:cover; border-radius:8px; margin:5px; cursor:pointer; }
    .delete-btn { color:red; cursor:pointer; }
    .action-buttons a { margin-right:10px; }
    .modal img { width:100%; border-radius:8px; margin-bottom:10px; }
    #mapPopup { height:400px; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav>
  <div class="nav-wrapper">
    <a href="home.html" class="brand-logo center">Elephant Alerts</a>
    <ul class="left">
      <li><a href="home.html"><i class="material-icons">home</i></a></li>
    </ul>
    <ul class="right">
      <li><a href="#!" id="whyBtn">Why my report is not showing?</a></li>
    </ul>
  </div>
</nav>

<div class="container">
  <!-- Filter -->
  <div class="input-field">
    <select id="filterSelect">
      <option value="all" selected>All Reports</option>
      <option value="sightings">Sightings</option>
      <option value="accidents">Accidents</option>
    </select>
    <label>Filter Reports</label>
  </div>

  <!-- Reports -->
  <div id="reportsContainer"></div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h5>Confirm Delete</h5>
    <div class="input-field">
      <input id="agentIdInput" type="text">
      <label for="agentIdInput">Enter Agent ID</label>
    </div>
    <div class="input-field">
      <select id="deleteReasonSelect">
        <option value="" disabled selected>Choose a reason</option>
        <option value="Duplicate report">Duplicate report</option>
        <option value="Inappropriate content">Inappropriate content</option>
        <option value="False information">False information</option>
        <option value="Other">Other</option>
      </select>
      <label>Reason for Deletion</label>
    </div>
    <div class="input-field" id="otherReasonField" style="display:none;">
      <textarea id="deleteReasonOther" class="materialize-textarea"></textarea>
      <label for="deleteReasonOther">Other Reason</label>
    </div>
    <label>
      <input type="checkbox" id="agreementCheck"/>
      <span>I confirm that I am authorized to delete this report.</span>
    </label>
  </div>
  <div class="modal-footer">
    <a href="#!" id="confirmDelete" class="btn red">Delete</a>
    <a href="#!" class="modal-close btn grey">Cancel</a>
  </div>
</div>

<!-- Deleted Report Info Modal -->
<div id="deletedInfoModal" class="modal">
  <div class="modal-content">
    <h5>Deleted Report Information</h5>
    <div id="deletedInfoContent"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" id="acceptDelete" class="btn green">Accept</a>
    <a href="#!" id="declineDelete" class="btn red">Decline</a>
  </div>
</div>

<!-- Map Popup -->
<div id="mapModal" class="modal">
  <div class="modal-content">
    <h5>Report Location</h5>
    <div id="mapPopup"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn grey">Close</a>
  </div>
</div>

<!-- Images Popup -->
<div id="imagesModal" class="modal">
  <div class="modal-content">
    <h5>Report Images</h5>
    <div id="imagesContainer"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn grey">Close</a>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, remove, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.appspot.com",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Init Materialize
document.addEventListener("DOMContentLoaded",()=>{
  M.FormSelect.init(document.querySelectorAll("select"));
  M.Modal.init(document.querySelectorAll(".modal"));
});

let deleteTarget = null;
let deleteReportData = null;

// Load Reports
async function loadReports(){
  const snap = await get(ref(db,"reports"));
  if(!snap.exists()){
    document.getElementById("reportsContainer").innerHTML="<p>No reports available.</p>";
    return;
  }
  renderReports(snap.val());
}

function renderReports(data){
  const filter=document.getElementById("filterSelect").value;
  const container=document.getElementById("reportsContainer");
  container.innerHTML="";

  Object.entries(data).forEach(([type,reports])=>{
    if(filter!=="all" && type!==filter) return;
    Object.entries(reports).forEach(([id,report])=>{
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <div class="card-content">
          <span class="card-title">${type.toUpperCase()} Report</span>
          <p><b>District:</b> ${report.district||"Unknown"}</p>
          <p><b>Elephants:</b> ${report.numElephants||0}</p>
          <p><b>Danger:</b> ${report.dangerLevel||"N/A"}</p>
          <p><b>Description:</b> ${report.description||"N/A"}</p>
          <p><b>Time:</b> ${report.time||"N/A"}</p>
        </div>
        <div class="card-action action-buttons">
          <a href="#!" class="btn green map-btn" data-lat="${report.lat}" data-lng="${report.lng}" data-district="${report.district}">Map</a>
          <a href="#!" class="btn blue image-btn" data-images='${JSON.stringify(report.images||{})}'>Images</a>
          <a href="#!" class="btn orange pdf-btn" data-report='${JSON.stringify(report)}'>PDF</a>
          ${localStorage.getItem("agentId")?`<a href="#!" class="delete-btn right" data-id="${id}" data-type="${type}">Delete</a>`:""}
        </div>
      `;
      container.appendChild(card);

      // Delete button handler
      const delBtn=card.querySelector(".delete-btn");
      if(delBtn){
        delBtn.addEventListener("click",()=>{
          deleteTarget={id,type};
          deleteReportData=report;
          M.Modal.getInstance(document.getElementById("deleteModal")).open();
        });
      }

      // Map button handler
      card.querySelector(".map-btn").addEventListener("click",(e)=>{
        const lat=e.target.getAttribute("data-lat");
        const lng=e.target.getAttribute("data-lng");
        const district=e.target.getAttribute("data-district");
        const mapModal=document.getElementById("mapModal");
        M.Modal.getInstance(mapModal).open();
        setTimeout(()=>{
          const map=L.map("mapPopup").setView([lat,lng],12);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
          L.marker([lat,lng]).addTo(map).bindPopup(district).openPopup();
        },200);
      });

      // Image button handler
      card.querySelector(".image-btn").addEventListener("click",(e)=>{
        const imgs=JSON.parse(e.target.getAttribute("data-images"));
        const container=document.getElementById("imagesContainer");
        container.innerHTML="";
        Object.values(imgs).forEach(img=>{
          const el=document.createElement("img");
          el.src=img;
          container.appendChild(el);
        });
        M.Modal.getInstance(document.getElementById("imagesModal")).open();
      });

      // PDF button handler
      card.querySelector(".pdf-btn").addEventListener("click",(e)=>{
        const { jsPDF } = window.jspdf;
        const doc=new jsPDF();
        const report=JSON.parse(e.target.getAttribute("data-report"));
        doc.text("Elephant Report",20,20);
        doc.text(`District: ${report.district}`,20,30);
        doc.text(`Elephants: ${report.numElephants}`,20,40);
        doc.text(`Danger: ${report.dangerLevel}`,20,50);
        doc.text(`Description: ${report.description}`,20,60);
        doc.text(`Time: ${report.time}`,20,70);
        doc.save("report.pdf");
      });
    });
  });
}

// Delete confirm
document.getElementById("deleteReasonSelect").addEventListener("change",e=>{
  document.getElementById("otherReasonField").style.display=e.target.value==="Other"?"block":"none";
});

document.getElementById("confirmDelete").addEventListener("click",async()=>{
  const agentId=localStorage.getItem("agentId");
  const inputId=document.getElementById("agentIdInput").value;
  let reason=document.getElementById("deleteReasonSelect").value;
  if(reason==="Other") reason=document.getElementById("deleteReasonOther").value;
  const agree=document.getElementById("agreementCheck").checked;

  if(!inputId || inputId!==agentId){ alert("Agent ID incorrect."); return; }
  if(!reason.trim()){ alert("Please provide a reason."); return; }
  if(!agree){ alert("You must confirm agreement."); return; }

  if(deleteTarget && deleteReportData){
    await set(ref(db,"deletedReports/"+deleteTarget.id),{
      ...deleteReportData,
      deletedBy:agentId,
      agentName:"Unknown (Unknown)",
      agentMobile:"Unknown",
      reason:reason,
      timestamp:new Date().toISOString()
    });
    await remove(ref(db,`reports/${deleteTarget.type}/${deleteTarget.id}`));
    deleteTarget=null; deleteReportData=null;
    M.Modal.getInstance(document.getElementById("deleteModal")).close();
    loadReports();
  }
});

// Why my report not showing
document.getElementById("whyBtn").addEventListener("click",async()=>{
  const emaId=localStorage.getItem("emaId");
  if(!emaId){ alert("You must be logged in as a reporter."); return; }

  const snap=await get(ref(db,"deletedReports"));
  if(!snap.exists()){ alert("No deleted reports found."); return; }
  const data=snap.val();

  let found=null, foundId=null;
  Object.entries(data).forEach(([id,rep])=>{
    if(rep.userId===emaId && !found){ found=rep; foundId=id; }
  });

  if(found){
    document.getElementById("deletedInfoContent").innerHTML=`
      <p><b>Reason:</b> ${found.reason}</p>
      <p><b>Agent:</b> ${found.agentName} (${found.agentMobile})</p>
      <p><b>Time:</b> ${found.timestamp}</p>
      <p><b>Description:</b> ${found.description}</p>
    `;
    M.Modal.getInstance(document.getElementById("deletedInfoModal")).open();

    document.getElementById("acceptDelete").onclick=async()=>{
      await remove(ref(db,"deletedReports/"+foundId));
      M.Modal.getInstance(document.getElementById("deletedInfoModal")).close();
    };
    document.getElementById("declineDelete").onclick=async()=>{
      alert("We're taking actions about it. It may take up-to 2 to 3 days. Stay Updated");
      await set(ref(db,"deletedReports/"+foundId+"/actionNeeded"),true);
      M.Modal.getInstance(document.getElementById("deletedInfoModal")).close();
    };
  }else{
    alert("No deleted reports found for your account.");
  }
});

document.getElementById("filterSelect").addEventListener("change",()=>loadReports());
loadReports();
</script>
</body>
</html>
