<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elephant Alerts</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<style>
body { font-family: Roboto, sans-serif; background:#fafafa; margin:0; }
#topButtons { display:flex; justify-content:space-between; margin:10px; }
#reportsContainer { margin:0 10px; }
.card .card-content { padding:10px; }
.card-action { display:flex; justify-content:space-between; }
.map-popup, .img-popup { width:100%; height:300px; }
.fixed-btn { position:fixed; bottom:20px; right:20px; }
.pdf-btn { background:#00796b; color:white; padding:10px; border-radius:8px; cursor:pointer; }
.delete-btn { background:red; color:white; padding:10px; border-radius:8px; cursor:pointer; }
.modal { max-height:90%; }
</style>
</head>
<body>

<div id="topButtons">
  <div>
    <select id="filterType">
      <option value="sightings">Sightings</option>
      <option value="accidents">Accidents</option>
    </select>
    <select id="filterDistrict"><option value="">All Districts</option></select>
  </div>
  <a id="whyBtn" class="btn orange">Why is my report not showing?</a>
  <a href="home.html" class="btn green">Home</a>
</div>

<div id="reportsContainer"></div>

<div id="whyModal" class="modal"><div class="modal-content"><h5>Deleted Reports</h5><div id="deletedContainer"></div></div><div class="modal-footer"><a href="#!" class="modal-close btn red">Close</a></div></div>
<div id="mapModal" class="modal"><div class="modal-content"><div id="map" class="map-popup"></div></div><div class="modal-footer"><a href="#!" class="modal-close btn red">Close</a></div></div>
<div id="imgModal" class="modal"><div class="modal-content" id="imgContent"></div><div class="modal-footer"><a href="#!" class="modal-close btn red">Close</a></div></div>
<div id="deleteModal" class="modal"><div class="modal-content"><h5>Delete Report</h5>
<form id="deleteForm">
  <div class="input-field"><select id="deleteReason"><option value="" disabled selected>Reason</option><option value="Fake Report">Fake Report</option><option value="Miscontent">Miscontent</option><option value="Fraud Information">Fraud Information</option><option value="Description is fake">Description is fake</option><option value="Duplicate Report">Duplicate Report</option><option value="Other">Other</option></select><label>Reason</label></div>
  <div class="input-field"><input type="text" id="agentName" readonly><label>Agent Name</label></div>
  <p><label><input type="checkbox" id="agreement"/><span>I agree this information is correct and will not harass anyone.</span></label></p>
  <input type="hidden" id="deleteReportId">
  <a href="#!" id="confirmDelete" class="btn red">Delete</a>
</form>
</div><div class="modal-footer"><a href="#!" class="modal-close btn grey">Cancel</a></div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, child, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

document.addEventListener("DOMContentLoaded",async()=>{
  M.Modal.init(document.querySelectorAll('.modal'));
  M.FormSelect.init(document.querySelectorAll('select'));

  const districts=["Ampara","Anuradhapura","Badulla","Batticaloa","Colombo","Galle","Gampaha","Hambantota","Jaffna","Kalutara","Kandy","Kegalle","Kilinochchi","Kurunegala","Mannar","Matale","Matara","Monaragala","Mullaitivu","Nuwara Eliya","Polonnaruwa","Puttalam","Ratnapura","Trincomalee","Vavuniya"];
  const districtSelect=document.getElementById("filterDistrict");
  districts.forEach(d=>{ let opt=document.createElement("option"); opt.value=d; opt.textContent=d; districtSelect.appendChild(opt); });
  M.FormSelect.init(document.querySelectorAll('select'));

  function getCookie(name){ let m=document.cookie.match("(^|;)\\s*"+name+"\\s*=\\s*([^;]+)"); return m?m.pop():""; }
  const userId=getCookie("emaId");
  if(!userId){window.location.href="index.html"; return;}
  const userSnap=await get(child(ref(db),"users/"+userId));
  const userData=userSnap.exists()?userSnap.val():{};
  document.getElementById("agentName").value=userData.name||"";

  const reportsContainer=document.getElementById("reportsContainer");
  async function loadReports(){
    reportsContainer.innerHTML="";
    const type=document.getElementById("filterType").value;
    const district=document.getElementById("filterDistrict").value;
    const reportsSnap=await get(ref(db,"reports/"+type));
    if(!reportsSnap.exists()) return;
    const now=new Date().getTime();
    Object.entries(reportsSnap.val()).forEach(([rid,r])=>{
      const repDate=new Date(r.time).getTime();
      if(now-repDate>24*60*60*1000) return;
      if(district && r.district!==district) return;
      const card=document.createElement("div"); card.className="card";
      let html=`<div class="card-content"><span class="card-title">${type.toUpperCase()}</span><p><b>Reporter:</b> ${r.userName} (${r.userMobile})</p><p><b>District:</b> ${r.district}</p><p><b>Elephants:</b> ${r.numElephants||"-"}</p><p><b>Danger Level:</b> ${r.dangerLevel||"-"}</p><p>${r.description||""}</p></div><div class="card-action">`;
      html+=`<a href="#!" class="map-btn" data-lat="${r.lat}" data-lng="${r.lng}"><i class="material-icons">map</i></a>`;
      html+=`<a href="#!" class="img-btn" data-images='${JSON.stringify(r.images||[])}'><i class="material-icons">image</i></a>`;
      html+=`<a href="#!" class="pdf-btn">PDF</a>`;
      if(userData.agentId) html+=`<a href="#deleteModal" class="delete-btn modal-trigger" data-id="${rid}" data-type="${type}">Delete</a>`;
      html+="</div>";
      card.innerHTML=html;
      reportsContainer.appendChild(card);
    });
    document.querySelectorAll(".map-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const lat=btn.dataset.lat; const lng=btn.dataset.lng;
        const modal=document.getElementById("mapModal");
        M.Modal.getInstance(modal).open();
        setTimeout(()=>{ const map=L.map("map").setView([lat,lng],13); L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map); L.marker([lat,lng]).addTo(map); },50);
      });
    });
    document.querySelectorAll(".img-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const imgs=JSON.parse(btn.dataset.images||"[]");
        const content=document.getElementById("imgContent"); content.innerHTML="";
        imgs.forEach(src=>{ let i=document.createElement("img"); i.src=src; i.style.width="100%"; i.style.marginBottom="10px"; content.appendChild(i); });
        M.Modal.getInstance(document.getElementById("imgModal")).open();
      });
    });
    document.querySelectorAll(".pdf-btn").forEach(btn=>{
      btn.addEventListener("click", async()=>{
        const card=btn.closest(".card"); const { jsPDF } = window.jspdf;
        const pdf=new jsPDF(); await html2canvas(card).then(canvas=>{ const imgData=canvas.toDataURL("image/png"); pdf.addImage(imgData,"PNG",10,10,190,0); pdf.setFontSize(20); pdf.text("EMA",100,280,{align:"center"}); pdf.save("report.pdf"); });
      });
    });
    document.querySelectorAll(".delete-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.getElementById("deleteReportId").value=btn.dataset.id;
        document.getElementById("deleteForm").dataset.type=btn.dataset.type;
      });
    });
  }
  await loadReports();

  document.getElementById("filterType").addEventListener("change",loadReports);
  document.getElementById("filterDistrict").addEventListener("change",loadReports);

  document.getElementById("confirmDelete").addEventListener("click",async()=>{
    const reason=document.getElementById("deleteReason").value;
    const agree=document.getElementById("agreement").checked;
    const rid=document.getElementById("deleteReportId").value;
    const type=document.getElementById("deleteForm").dataset.type;
    if(!reason||!agree||!rid) return;
    const reportSnap=await get(child(ref(db,"reports/"+type+"/"+rid)));
    if(!reportSnap.exists()) return;
    const reportData=reportSnap.val();
    await update(ref(db,"deletedreportinfo/"+reportData.userId+"/"+rid),{report:reportData,deletedBy:userData.name,agentId:userData.agentId,reason});
    await remove(ref(db,"reports/"+type+"/"+rid));
    M.Modal.getInstance(document.getElementById("deleteModal")).close();
    loadReports();
  });

  document.getElementById("whyBtn").addEventListener("click",async()=>{
    const deletedContainer=document.getElementById("deletedContainer");
    deletedContainer.innerHTML="";
    const delSnap=await get(ref(db,"deletedreportinfo"));
    if(!delSnap.exists()) return;
    Object.entries(delSnap.val()).forEach(([uid,userReports])=>{
      Object.entries(userReports).forEach(([rid,rdata])=>{
        const dcard=document.createElement("div"); dcard.className="card";
        dcard.innerHTML=`<div class="card-content"><p><b>Reporter:</b> ${rdata.report.userName} (${rdata.report.userMobile})</p><p><b>Deleted By:</b> ${rdata.deletedBy} (${rdata.agentId})</p><p><b>Reason:</b> ${rdata.reason}</p></div>`;
        deletedContainer.appendChild(dcard);
      });
    });
    M.Modal.getInstance(document.getElementById("whyModal")).open();
  });

});
</script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</body>
</html>
