<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alerts - Elephant Monitoring App</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { font-family: Roboto, sans-serif; background:#f5f5f5; margin:0; padding:0; }
.container { max-width:500px; margin:auto; padding:10px; }
.card { margin:10px 0; border-radius:12px; }
.card-content { padding:12px; }
.card-title { font-weight:bold; }
.card-actions { display:flex; justify-content:flex-end; gap:10px; }
.icon-btn { cursor:pointer; font-size:1.2em; }
.icon-btn.delete { color:red; }
.fixed-buttons { display:flex; justify-content:space-between; margin:10px 0; }
select { display:inline-block; width:48%; }
.modal { max-height:90%; }
#mapPopup { height:300px; width:100%; }
.image-container img { width:80px; height:80px; margin:4px; cursor:pointer; object-fit:cover; border-radius:6px; }
</style>
</head>
<body>
<div class="container">
  <div class="fixed-buttons">
    <a id="btnHome" class="btn green">Home</a>
    <a id="btnWhy" class="btn blue">Why is my report not showing?</a>
  </div>
  <div class="fixed-buttons">
    <select id="typeFilter">
      <option value="sightings">Sightings</option>
      <option value="accidents">Accidents</option>
    </select>
    <select id="districtFilter">
      <option value="">All Districts</option>
    </select>
  </div>
  <div id="reportContainer"></div>
</div>

<div id="deletedReportsModal" class="modal">
  <div class="modal-content">
    <h5>Deleted Reports</h5>
    <div id="deletedContainer"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn red">Close</a>
  </div>
</div>

<div id="mapModal" class="modal">
  <div class="modal-content">
    <h5>Report Location</h5>
    <div id="mapPopup"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn red">Close</a>
  </div>
</div>

<div id="imageModal" class="modal">
  <div class="modal-content">
    <h5>Images</h5>
    <div class="image-container" id="imageContainer"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn red">Close</a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

document.addEventListener("DOMContentLoaded", async ()=>{
  const districts = ["Ampara","Anuradhapura","Badulla","Batticaloa","Colombo","Galle","Gampaha","Hambantota","Jaffna","Kalutara","Kandy","Kegalle","Kilinochchi","Kurunegala","Mannar","Matale","Matara","Monaragala","Mullaitivu","Nuwara Eliya","Polonnaruwa","Puttalam","Ratnapura","Trincomalee","Vavuniya"];
  const districtFilter = document.getElementById("districtFilter");
  districts.forEach(d=>{ let o=document.createElement("option"); o.value=d;o.textContent=d; districtFilter.appendChild(o); });
  M.FormSelect.init(document.querySelectorAll('select'));
  M.Modal.init(document.querySelectorAll('.modal'));

  const userId = "EMA-42DNDC"; 
  const userSnap = await get(ref(db,"users/"+userId));
  const user = userSnap.exists()? userSnap.val() : {role:"user",name:"Unknown",password:"",district:""};
  const isAgent = user.role && user.role.toLowerCase()==="agent";
  const userDistrict = user.district;

  let currentType = document.getElementById("typeFilter").value;
  let currentDistrict = "";

  async function loadReports(){
    const container = document.getElementById("reportContainer");
    container.innerHTML="";
    const snapshot = await get(ref(db,"reports/"+currentType));
    if(snapshot.exists()){
      const now = new Date().getTime();
      snapshot.forEach(snap=>{
        const report = snap.val();
        const key = snap.key;
        const reportTime = new Date(report.time).getTime();
        if(now-reportTime>24*3600*1000) return;
        if(currentDistrict && report.district!==currentDistrict) return;
        let deleteBtnHTML="";
        if(isAgent) deleteBtnHTML=`<i class="fas fa-trash icon-btn delete" data-key="${key}" data-type="${currentType}" data-userid="${report.userId}" data-district="${report.district}"></i>`;
        let html=`<div class="card">
          <div class="card-content">
            <span class="card-title">${report.description}</span>
            <p><b>Reporter:</b> ${report.userName} | <b>Mobile:</b> <span class="reporterMobile" data-num="${report.userMobile}">${report.userMobile}</span></p>
            <p><b>District:</b> ${report.district} | <b>Elephants:</b> ${report.numElephants} | <b>Danger:</b> ${report.dangerLevel}</p>
            <div class="card-actions">
              <i class="fas fa-map icon-btn map" data-lat="${report.lat}" data-lng="${report.lng}"></i>
              <i class="fas fa-image icon-btn images" data-images='${JSON.stringify(report.images||[])}'></i>
              ${deleteBtnHTML}
            </div>
          </div>
        </div>`;
        container.innerHTML+=html;
      });
      attachEvents();
    }
  }

  function attachEvents(){
    document.querySelectorAll(".map").forEach(m=>{
      m.onclick=()=>{
        const lat=parseFloat(m.dataset.lat), lng=parseFloat(m.dataset.lng);
        const mapModal=M.Modal.getInstance(document.getElementById("mapModal"));
        mapModal.open();
        const mapDiv = document.getElementById("mapPopup");
        mapDiv.innerHTML="";
        const map = L.map(mapDiv).setView([lat,lng],10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
        L.marker([lat,lng]).addTo(map);
      };
    });
    document.querySelectorAll(".images").forEach(i=>{
      i.onclick=()=>{
        const imgs = JSON.parse(i.dataset.images||"[]");
        const imgModal = M.Modal.getInstance(document.getElementById("imageModal"));
        imgModal.open();
        const container=document.getElementById("imageContainer");
        container.innerHTML="";
        imgs.forEach(src=>{
          const im = document.createElement("img"); im.src=src;
          container.appendChild(im);
        });
      };
    });
    document.querySelectorAll(".reporterMobile").forEach(r=>{
      r.onclick=()=>{navigator.clipboard.writeText(r.dataset.num); M.toast({html:"Copied!"});};
    });
    document.querySelectorAll(".delete").forEach(d=>{
      d.onclick=async()=>{
        const agentPass = prompt("Enter agent password:");
        if(agentPass!==user.password){alert("Incorrect password"); return;}
        if(d.dataset.district!==userDistrict){alert("You cannot delete reports outside your district!"); return;}
        const reason = prompt("Reason for deletion? fake report, miscontent, fraud info, description fake, duplicate, other");
        if(!reason) return;
        const reportType = d.dataset.type, rKey=d.dataset.key, rUser=d.dataset.userid;
        await set(ref(db,`deletedreportinfo/${rUser}/${rKey}`),{
          deletedBy:user.name,
          agentId:userId,
          agentMobile:user.mobile||"",
          reason,
          time:new Date().toLocaleString(),
          type:reportType
        });
        await set(ref(db,`reports/${reportType}/${rKey}`),null);
        loadReports();
      };
    });
  }

  loadReports();
  document.getElementById("typeFilter").onchange=e=>{currentType=e.target.value; loadReports();}
  districtFilter.onchange=e=>{currentDistrict=e.target.value; loadReports();}
  document.getElementById("btnWhy").onclick=async()=>{
    const deletedSnap = await get(ref(db,"deletedreportinfo"));
    const container = document.getElementById("deletedContainer");
    container.innerHTML="";
    if(deletedSnap.exists()){
      deletedSnap.forEach(userSnap=>{
        userSnap.forEach(rSnap=>{
          const r=rSnap.val();
          container.innerHTML+=`<div class="card">
            <div class="card-content">
              <p><b>Deleted By:</b> ${r.deletedBy} | <b>Mobile:</b> <span class="reporterMobile" data-num="${r.agentMobile}">${r.agentMobile}</span></p>
              <p><b>Reason:</b> ${r.reason}</p>
              <p><b>Type:</b> ${r.type} | <b>Time:</b> ${r.time}</p>
            </div>
          </div>`;
        });
      });
      attachEvents();
    }
    M.Modal.getInstance(document.getElementById("deletedReportsModal")).open();
  };
  document.getElementById("btnHome").onclick=()=>{window.location.href="home.html";};
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
