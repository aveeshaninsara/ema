<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alerts - Elephant Monitoring App</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window._fb = { db, ref, onValue, remove };
</script>

<style>
body { font-family: Roboto,sans-serif; background:#fafafa; margin:0; }
.container { padding:10px; max-width:600px; margin:auto; }
.card { margin-bottom:15px; border-radius:12px; }
.card .card-content p { margin:5px 0; }
.delete-btn { color:red; float:right; cursor:pointer; }
</style>
</head>
<body>
<div class="container">
  <h5>Elephant Reports</h5>
  <div id="reportsContainer"></div>
</div>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const { db, ref, onValue, remove } = window._fb;
  function getCookie(name){ let m=document.cookie.match("(^|;)\\s*"+name+"\\s*=\\s*([^;]+)"); return m?m.pop():""; }
  const agentId=getCookie("agentId")||localStorage.getItem("agentId");
  const isAgent=!!agentId;

  const reportsContainer=document.getElementById("reportsContainer");

  onValue(ref(db,"reports"),snap=>{
    reportsContainer.innerHTML="";
    if(snap.exists()){
      snap.forEach(r=>{
        const data=r.val(); const key=r.key;
        const card=document.createElement("div");
        card.className="card white";
        card.innerHTML=`
          <div class="card-content">
            <span class="card-title">${data.district||"Unknown District"}
              ${isAgent?`<i class="fa-solid fa-trash delete-btn" data-id="${key}" title="Delete"></i>`:""}
            </span>
            <p><b>Elephants:</b> ${data.elephantCount||0}</p>
            <p><b>Danger:</b> ${data.danger||"N/A"}</p>
            <p><b>Incident:</b> ${data.incidentType||"N/A"}</p>
            <p><b>Reporter:</b> ${data.reporterName||"Anonymous"}</p>
            ${data.image?`<img src="${data.image}" style="max-width:100%; border-radius:8px; margin-top:8px;">`:""}
          </div>`;
        reportsContainer.appendChild(card);
      });

      if(isAgent){
        document.querySelectorAll(".delete-btn").forEach(btn=>{
          btn.addEventListener("click",()=>{
            const id=btn.getAttribute("data-id");
            const entered=prompt("Enter your Agent ID to confirm delete:");
            if(entered===agentId){
              remove(ref(db,"reports/"+id));
              M.toast({html:"Report deleted"});
            }else{
              M.toast({html:"Invalid Agent ID"});
            }
          });
        });
      }
    }else{
      reportsContainer.innerHTML="<p>No reports yet.</p>";
    }
  });
});
</script>
</body>
</html>
