<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alerts</title>

  <!-- Materialize CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { background: #f9f9f9; font-family: Arial, sans-serif; }
    .filter-bar { margin: 15px; }
    .report-card { margin: 10px; border-radius: 12px; }
    .map-popup { height: 300px; }
    .icon-btn { margin-right: 10px; cursor: pointer; }
    .delete-btn { margin-top: 10px; }
    .floating-btn { position: fixed; bottom: 20px; right: 20px; }
    .modal { max-height: 90% !important; }
  </style>
</head>
<body>

  <!-- Filter Bar -->
  <div class="filter-bar row">
    <div class="input-field col s6">
      <select id="filterType">
        <option value="sightings" selected>Sightings</option>
        <option value="accidents">Accidents</option>
      </select>
      <label>Report Type</label>
    </div>
    <div class="input-field col s6">
      <select id="filterDistrict">
        <option value="all" selected>All Districts</option>
        <option>Ampara</option>
        <option>Anuradhapura</option>
        <option>Badulla</option>
        <option>Batticaloa</option>
        <option>Colombo</option>
        <option>Galle</option>
        <option>Gampaha</option>
        <option>Hambantota</option>
        <option>Jaffna</option>
        <option>Kalutara</option>
        <option>Kandy</option>
        <option>Kegalle</option>
        <option>Kilinochchi</option>
        <option>Kurunegala</option>
        <option>Mannar</option>
        <option>Matale</option>
        <option>Matara</option>
        <option>Monaragala</option>
        <option>Mullaitivu</option>
        <option>Nuwara Eliya</option>
        <option>Polonnaruwa</option>
        <option>Puttalam</option>
        <option>Ratnapura</option>
        <option>Trincomalee</option>
        <option>Vavuniya</option>
      </select>
      <label>District</label>
    </div>
  </div>

  <!-- Why my report not showing -->
  <div class="center-align">
    <a class="btn red lighten-1 modal-trigger" href="#deletedReportsModal">Why is my report not showing?</a>
  </div>

  <!-- Reports Container -->
  <div id="reportsContainer" class="container"></div>

  <!-- Deleted Reports Modal -->
  <div id="deletedReportsModal" class="modal">
    <div class="modal-content">
      <h5>Deleted Reports</h5>
      <ul id="deletedReportsList" class="collection"></ul>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Close</a>
    </div>
  </div>

  <!-- Map Modal -->
  <div id="mapModal" class="modal">
    <div class="modal-content">
      <h5>Report Location</h5>
      <div id="map" class="map-popup"></div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <h5>Report Images</h5>
      <div id="imageContainer"></div>
    </div>
  </div>

  <!-- Delete Report Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h5>Delete Report</h5>
      <div class="input-field">
        <select id="deleteReason">
          <option value="Fake report">Fake report</option>
          <option value="Miscontent">Miscontent</option>
          <option value="Fraud information">Fraud information</option>
          <option value="Description is fake">Description is fake</option>
          <option value="Duplicate report">Duplicate report</option>
          <option value="Other">Other</option>
        </select>
        <label>Reason</label>
      </div>
      <div class="input-field">
        <input id="agentId" type="text" placeholder="Enter your Agent ID">
        <label for="agentId">Agent ID</label>
      </div>
      <p>
        <label>
          <input type="checkbox" id="deleteAgreement">
          <span>I agree this information is correct and not harassment</span>
        </label>
      </p>
      <button class="btn red" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
    // ---- FIREBASE CONFIG ----
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
      databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "elephant-monitoring-app-99ffd",
      storageBucket: "elephant-monitoring-app-99ffd.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---- INIT ----
    document.addEventListener('DOMContentLoaded', function() {
      M.AutoInit();
      loadReports();
    });

    // ---- LOAD REPORTS ----
    async function loadReports() {
      const type = document.getElementById("filterType").value;
      const district = document.getElementById("filterDistrict").value;
      const reportsContainer = document.getElementById("reportsContainer");
      reportsContainer.innerHTML = "<p class='center'>Loading...</p>";

      const snapshot = await db.ref("reports/" + type).get();
      reportsContainer.innerHTML = "";

      snapshot.forEach(child => {
        const report = child.val();
        const id = child.key;

        // Only show last 24 hours
        const reportTime = new Date(report.time);
        if (Date.now() - reportTime.getTime() > 24 * 60 * 60 * 1000) return;

        if (district !== "all" && report.district !== district) return;

        const card = document.createElement("div");
        card.className = "card report-card";

        card.innerHTML = `
          <div class="card-content">
            <span class="card-title">${report.district} - ${report.dangerLevel}</span>
            <p>${report.description}</p>
            <div class="section">
              <i class="fas fa-map-marker-alt icon-btn" onclick="showMap(${report.lat}, ${report.lng})"></i>
              <i class="fas fa-image icon-btn" onclick='showImages(${JSON.stringify(report.images || [])})'></i>
              <i class="fas fa-file-pdf icon-btn" onclick='downloadPDF(${JSON.stringify(report)})'></i>
            </div>
            ${isAgent() ? `<button class="btn red delete-btn modal-trigger" href="#deleteModal" onclick="prepareDelete('${type}', '${id}', '${report.userId}', '${report.userName}', '${report.userMobile}')">Delete</button>` : ""}
          </div>
        `;
        reportsContainer.appendChild(card);
      });
    }

    // ---- MAP ----
    let map;
    function showMap(lat, lng) {
      const modal = M.Modal.getInstance(document.getElementById("mapModal"));
      modal.open();
      setTimeout(() => {
        if (!map) {
          map = L.map("map").setView([lat, lng], 10);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        }
        map.setView([lat, lng], 12);
        L.marker([lat, lng]).addTo(map);
      }, 300);
    }

    // ---- IMAGES ----
    function showImages(images) {
      const container = document.getElementById("imageContainer");
      container.innerHTML = "";
      (images || []).forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.style.width = "100%";
        img.className = "responsive-img";
        container.appendChild(img);
      });
      M.Modal.getInstance(document.getElementById("imageModal")).open();
    }

    // ---- PDF ----
    function downloadPDF(report) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(`District: ${report.district}`, 10, 10);
      doc.text(`Danger Level: ${report.dangerLevel}`, 10, 20);
      doc.text(`Description: ${report.description}`, 10, 30);
      doc.text(`Time: ${report.time}`, 10, 40);
      doc.save("report.pdf");
    }

    // ---- DELETE REPORT ----
    let deleteContext = {};
    function prepareDelete(type, id, userId, userName, userMobile) {
      deleteContext = { type, id, userId, userName, userMobile };
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
      const reason = document.getElementById("deleteReason").value;
      const agentId = document.getElementById("agentId").value;
      const agreed = document.getElementById("deleteAgreement").checked;

      if (!reason || !agentId || !agreed) {
        alert("Fill all fields and agree!");
        return;
      }

      const { type, id, userId, userName, userMobile } = deleteContext;
      const agentName = localStorage.getItem("userName") || "Unknown";

      // Save to deleted reports
      await db.ref(`deletedreportinfo/${userId}/${id}`).set({
        reason, agentId, agentName, userName, userMobile, deletedAt: new Date().toISOString()
      });

      // Remove from reports
      await db.ref(`reports/${type}/${id}`).remove();

      M.Modal.getInstance(document.getElementById("deleteModal")).close();
      loadReports();
    });

    // ---- DELETED REPORTS ----
    document.querySelector("#deletedReportsModal").addEventListener("click", async () => {
      const list = document.getElementById("deletedReportsList");
      list.innerHTML = "<li class='collection-item'>Loading...</li>";

      const snapshot = await db.ref("deletedreportinfo").get();
      list.innerHTML = "";
      snapshot.forEach(user => {
        user.forEach(report => {
          const val = report.val();
          const li = document.createElement("li");
          li.className = "collection-item";
          li.innerHTML = `
            <b>Reason:</b> ${val.reason}<br>
            <b>Agent:</b> ${val.agentName} (${val.agentId})<br>
            <b>Contact:</b> <a href="tel:${val.userMobile}">${val.userMobile}</a>
          `;
          list.appendChild(li);
        });
      });
    });

    // ---- IS AGENT ----
    function isAgent() {
      return localStorage.getItem("isAgent") === "true";
    }

    // Reload reports when filters change
    document.getElementById("filterType").addEventListener("change", loadReports);
    document.getElementById("filterDistrict").addEventListener("change", loadReports);
  </script>
</body>
</html>
