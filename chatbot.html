<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ali AI Chatbot</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<style>
  body { background: #f4f4f4; font-family: 'Roboto', sans-serif; }
  .chat-container { max-width: 600px; margin: 50px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; flex-direction: column; height: 80vh; }
  .chat-window { flex: 1; padding: 10px; overflow-y: auto; }
  .chat-input { display: flex; border-top: 1px solid #ddd; }
  .chat-input input { flex: 1; padding: 10px; border: none; outline: none; font-size: 1rem; }
  .chat-input button { padding: 0 20px; background: #2e7d32; color: #fff; border: none; cursor: pointer; }
  .bubble { padding: 10px 15px; margin: 5px 0; border-radius: 20px; max-width: 80%; display: inline-block; }
  .bot { background: #e0f2f1; align-self: flex-start; }
  .user { background: #2e7d32; color: #fff; align-self: flex-end; }
</style>
</head>
<body>

<div class="chat-container">
  <div id="chatWindow" class="chat-window"></div>
  <div class="chat-input">
    <input type="text" id="userInput" placeholder="Type your message..."/>
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const chatWindow = document.getElementById("chatWindow");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

const API_KEY = "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";

// Local knowledge base
const knowledgeBase = [
  { keywords: ["elephant"], answer: "Sri Lankan elephants are endangered and found in national parks." },
  { keywords: ["yala"], answer: "Yala National Park is famous for elephants and leopards." },
  { keywords: ["udawalawe"], answer: "Udawalawe National Park is ideal for elephant sightings." },
  { keywords: ["ema"], answer: "EMA stands for Elephant Monitoring App, created by Aveesha Ninsara Pelawaththa." },
];

// Strict message for unrelated topics
const strictMsg = "Sorry, I can only answer about Sri Lanka wildlife, tourism, or EMA.";

function appendMessage(msg, sender){
  const bubble = document.createElement("div");
  bubble.className = `bubble ${sender}`;
  bubble.textContent = msg;
  chatWindow.appendChild(bubble);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

async function fetchOpenRouterReply(message){
  try {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "sk-or-v1",
        messages: [
          { role: "system", content: "You are Ali AI. Answer only about Sri Lanka wildlife, tourism, and EMA. Keep responses short. If unrelated, respond: 'Sorry, I can only answer about Sri Lanka wildlife, tourism, or EMA.' Mention Aveesha Ninsara Pelawaththa if asked about the creator." },
          { role: "user", content: message }
        ],
        temperature: 0.7
      })
    });

    if(!response.ok){
      console.error("OpenRouter API error:", response.status, await response.text());
      return strictMsg;
    }

    const data = await response.json();
    return data.choices[0].message.content.trim() || strictMsg;

  } catch(err){
    console.error("Fetch error:", err);
    return strictMsg;
  }
}

async function getBotReply(message){
  // Check local knowledge first
  const lowerMsg = message.toLowerCase();
  for(const item of knowledgeBase){
    for(const kw of item.keywords){
      if(lowerMsg.includes(kw.toLowerCase())){
        return item.answer;
      }
    }
  }

  // Fetch OpenRouter AI reply
  return await fetchOpenRouterReply(message);
}

async function sendMessage(){
  const msg = userInput.value.trim();
  if(!msg) return;
  appendMessage(msg, "user");
  userInput.value = "";

  const reply = await getBotReply(msg);
  appendMessage(reply, "bot");
}

sendBtn.addEventListener("click", sendMessage);
userInput.addEventListener("keypress", e => { if(e.key === "Enter") sendMessage(); });
</script>

</body>
</html>
