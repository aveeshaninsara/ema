<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Elephant Monitoring App</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, update, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window._fb = { db, ref, get, update, child };
</script>

<style>
body { font-family: Roboto, sans-serif; background: #fafafa; margin: 0; }
.container { padding: 8px; max-width: 420px; margin: 0 auto; }
.card-thin { padding: 8px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
.profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
.stat-card { display: flex; flex-wrap: wrap; justify-content: space-between; padding: 8px 12px; border-radius: 10px; margin-bottom: 10px; }
.stat-item { text-align: center; flex: 1 1 45%; margin-bottom: 6px; }
.stat-item h6 { margin: 0; font-weight: bold; }
.action-btns { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 10px; }
.fixed-btn { position: fixed; bottom: 16px; right: 16px; z-index: 1000; }
.ai-btn { position: fixed; bottom: 16px; left: 16px; background: #2e7d32; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; }
</style>
</head>
<body>

<div class="container">
  <div class="card white card-thin" id="profileCard">
    <div class="valign-wrapper">
      <img id="profilePic" src="" class="profile-pic">
      <div style="margin-left:10px;">
        <h6 id="profileName">Loading...</h6>
        <p id="profileEmail" class="grey-text" style="font-size:0.85rem"></p>
        <p id="agentStatus" class="green-text" style="font-size:0.85rem"></p>
      </div>
    </div>
  </div>

  <div class="card white stat-card">
    <div class="stat-item"><h6 id="statElephants">0</h6><span>Elephants</span></div>
    <div class="stat-item"><h6 id="statReports">0</h6><span>Reports</span></div>
    <div class="stat-item"><h6 id="statDanger">0</h6><span>High Danger</span></div>
    <div class="stat-item"><h6 id="statDeaths">0</h6><span>Deaths</span></div>
  </div>

  <div class="action-btns">
    <a href="report.html" class="btn green">Report</a>
    <a href="alert.html" class="btn red">Alert</a>
    <a href="radar.html" class="btn blue">Radar</a>
    <a href="analytics.html" class="btn orange">Analytics</a>
  </div>
</div>

<a href="report.html" class="btn-floating btn-large green fixed-btn"><i class="material-icons">add</i></a>
<a href="chatbot.html" class="ai-btn"><i class="material-icons">smart_toy</i></a>

<!-- Profile Modal -->
<div id="editProfileModal" class="modal">
  <div class="modal-content">
    <h5>Edit Profile</h5>
    <div class="input-field"><input type="text" id="editName"><label for="editName">Name</label></div>
    <div class="input-field"><input type="email" id="editEmail"><label for="editEmail">Email</label></div>
    <div class="input-field"><input type="text" id="editMobile"><label for="editMobile">Mobile</label></div>
    <div class="input-field"><select id="editDistrict"></select><label>District</label></div>
    <div class="file-field input-field">
      <div class="btn green"><span>Profile Pic</span><input type="file" id="editPic"></div>
      <div class="file-path-wrapper"><input class="file-path validate" type="text"></div>
    </div>
    <div id="agentButtonContainer"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" id="btnSaveProfile" class="modal-close btn green">Save</a>
    <a href="#!" id="btnLogout" class="btn red">Sign Out</a>
  </div>
</div>

<!-- Agent Registration Modal -->
<div id="agentModal" class="modal">
  <div class="modal-content">
    <h5>Agent Registration</h5>
    <div class="input-field"><input type="text" id="agentName"><label>Name</label></div>
    <div class="input-field"><input type="text" id="agentNIC"><label>NIC</label></div>
    <div class="input-field"><input type="text" id="agentPhone"><label>Phone</label></div>
    <div class="input-field"><select id="agentDistrict"></select><label>District</label></div>
  </div>
  <div class="modal-footer">
    <a href="#!" id="btnRegisterAgent" class="btn green">Register</a>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded",()=>{
  M.Modal.init(document.querySelectorAll('.modal'));
  M.FormSelect.init(document.querySelectorAll('select'));

  const districts=["Ampara","Anuradhapura","Badulla","Batticaloa","Colombo","Galle","Gampaha","Hambantota","Jaffna","Kalutara","Kandy","Kegalle","Kilinochchi","Kurunegala","Mannar","Matale","Matara","Monaragala","Mullaitivu","Nuwara Eliya","Polonnaruwa","Puttalam","Ratnapura","Trincomalee","Vavuniya"];
  const districtSelect=document.getElementById("editDistrict");
  const agentDistrictSelect=document.getElementById("agentDistrict");
  districts.forEach(d=>{
    let opt=document.createElement("option");
    opt.value=d; opt.textContent=d;
    districtSelect.appendChild(opt.cloneNode(true));
    agentDistrictSelect.appendChild(opt);
  });
  M.FormSelect.init(document.querySelectorAll('select'));

  const { db, ref, get, update, child } = window._fb;
  function getCookie(name){let m=document.cookie.match("(^|;)\\s*"+name+"\\s*=\\s*([^;]+)");return m?m.pop():"";}
  const userId=getCookie("emaId"); if(!userId){window.location.href="index.html";return;}

  // Load profile + stats
  get(child(ref(db),"users/"+userId)).then(snap=>{
    if(snap.exists()){
      const u=snap.val();
      document.getElementById("profilePic").src=u.picBase64||"";
      document.getElementById("profileName").textContent=u.name;
      document.getElementById("profileEmail").textContent=u.email;
      if(u.agentId){
        document.getElementById("agentStatus").textContent="Agent ("+u.agentId+")";
        document.getElementById("agentButtonContainer").innerHTML='<a href="#!" id="btnUnregister" class="btn red">Unregister as Agent</a>';
        document.getElementById("btnUnregister").addEventListener("click",()=>{update(ref(db,"users/"+userId),{agentId:null,agentInfo:null});localStorage.removeItem("agentId");document.cookie="agentId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";location.reload();});
        // Save agentId in cookie + localStorage
        localStorage.setItem("agentId",u.agentId);
        document.cookie="agentId="+u.agentId+"; path=/";
      }else{
        document.getElementById("agentButtonContainer").innerHTML='<a href="#agentModal" class="btn modal-trigger green">Want to be an Agent?</a>';
        M.Modal.init(document.querySelectorAll(".modal"));
      }
      document.getElementById("editName").value=u.name;
      document.getElementById("editEmail").value=u.email;
      document.getElementById("editMobile").value=u.mobile;
      document.getElementById("editDistrict").value=u.district;
      M.updateTextFields(); M.FormSelect.init(document.querySelectorAll("select"));
    }
  });

  // Save profile
  document.getElementById("btnSaveProfile").addEventListener("click",async()=>{
    const file=document.getElementById("editPic").files[0];
    let updates={name:editName.value,email:editEmail.value,mobile:editMobile.value,district:editDistrict.value};
    if(file){
      const reader=new FileReader();
      reader.onload=async()=>{updates.picBase64=reader.result; await update(ref(db,"users/"+userId),updates); location.reload();};
      reader.readAsDataURL(file);
    }else{await update(ref(db,"users/"+userId),updates); location.reload();}
  });

  // Logout
  document.getElementById("btnLogout").addEventListener("click",()=>{
    document.cookie="emaId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
    localStorage.clear(); sessionStorage.clear();
    window.location.href="index.html";
  });

  // Register Agent
  document.getElementById("btnRegisterAgent").addEventListener("click",async()=>{
    const agentId="EA-"+Math.floor(1000+Math.random()*9000);
    const info={name:agentName.value,nic:agentNIC.value,phone:agentPhone.value,district:agentDistrict.value};
    await update(ref(db,"users/"+userId),{agentId,agentInfo:info});
    localStorage.setItem("agentId",agentId);
    document.cookie="agentId="+agentId+"; path=/";
    location.reload();
  });

  // Stats = count reports dynamically
  get(ref(db,"reports")).then(snap=>{
    if(snap.exists()){
      const reports=snap.val(); let elephants=0, count=0, danger=0, deaths=0;
      Object.values(reports).forEach(r=>{count++; elephants+=r.elephants||0; if(r.danger==="High") danger++; if(r.incident==="Death") deaths++;});
      statElephants.textContent=elephants; statReports.textContent=count; statDanger.textContent=danger; statDeaths.textContent=deaths;
    }
  });

  profileCard.addEventListener("click",()=>{M.Modal.getInstance(editProfileModal).open();});
});
</script>
</body>
</html>
