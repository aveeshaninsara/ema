<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Elephant Monitoring App</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, update, child, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmhg4ZAqqlV5NTyYZNH2MT8m1YQxHkzo",
  authDomain: "elephant-monitoring-app-99ffd.firebaseapp.com",
  projectId: "elephant-monitoring-app-99ffd",
  storageBucket: "elephant-monitoring-app-99ffd.firebasestorage.app",
  messagingSenderId: "649960879930",
  appId: "1:649960879930:web:d6f703cea9029a2fd14203",
  measurementId: "G-GSQEVX635R",
  databaseURL: "https://elephant-monitoring-app-99ffd-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window._fb = { db, ref, get, update, child, onValue };
</script>

<style>
body { font-family: Roboto, sans-serif; margin: 0; background: #fafafa; }
.container { padding: 8px; max-width: 420px; margin: 0 auto; }
.card-thin { padding: 8px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
.profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
.stat-card { display: flex; flex-wrap: wrap; justify-content: space-between; padding: 8px 12px; border-radius: 10px; margin-bottom: 10px; }
.stat-item { text-align: center; flex: 1 1 45%; margin-bottom: 6px; }
.stat-item h6 { margin: 0; font-weight: bold; }
.action-btns { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 10px; }
.fixed-btn { position: fixed; bottom: 16px; right: 16px; z-index: 1000; }
.ai-btn { position: fixed; bottom: 16px; left: 16px; background: #2e7d32; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; z-index: 1000; }
</style>
</head>
<body>

<div class="container">

  <div class="card white card-thin" id="profileCard">
    <div class="valign-wrapper">
      <img id="profilePic" src="" class="profile-pic">
      <div style="margin-left:10px;">
        <h6 id="profileName">Loading...</h6>
        <p id="profileEmail" class="grey-text" style="font-size:0.85rem"></p>
        <p id="agentStatus" class="green-text" style="font-size:0.85rem"></p>
      </div>
    </div>
  </div>

  <div class="card white stat-card">
    <div class="stat-item"><h6 id="statElephants">0</h6><span>Elephants</span></div>
    <div class="stat-item"><h6 id="statReports">0</h6><span>Reports</span></div>
    <div class="stat-item"><h6 id="statDanger">0</h6><span>High Danger</span></div>
    <div class="stat-item"><h6 id="statDeaths">0</h6><span>Deaths</span></div>
  </div>

  <div class="action-btns">
    <a href="report.html" class="btn green">Report</a>
    <a href="alert.html" class="btn red">Alert</a>
    <a href="radar.html" class="btn blue">Radar</a>
    <a href="analytics.html" class="btn orange">Analytics</a>
  </div>

</div>

<a href="report.html" class="btn-floating btn-large green fixed-btn"><i class="material-icons">add</i></a>
<a href="chatbot.html" class="ai-btn"><i class="material-icons">smart_toy</i></a>

<div id="editProfileModal" class="modal">
  <div class="modal-content">
    <h5>Edit Profile</h5>
    <div class="input-field"><input type="text" id="editName"><label for="editName">Name</label></div>
    <div class="input-field"><input type="email" id="editEmail"><label for="editEmail">Email</label></div>
    <div class="input-field"><input type="text" id="editMobile"><label for="editMobile">Mobile</label></div>
    <div class="input-field"><select id="editDistrict"></select><label>District</label></div>
    <div class="file-field input-field">
      <div class="btn green"><span>Profile Pic</span><input type="file" id="editPic"></div>
      <div class="file-path-wrapper"><input class="file-path validate" type="text"></div>
    </div>
    <div id="agentButtonContainer"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" id="btnSaveProfile" class="modal-close btn green">Save</a>
    <a href="#!" id="btnLogout" class="btn red">Sign Out</a>
  </div>
</div>

<div id="agentModal" class="modal">
  <div class="modal-content">
    <h5>Agent Registration</h5>
    <div class="input-field"><input type="text" id="agentName"><label>Name</label></div>
    <div class="input-field"><input type="text" id="agentNIC"><label>NIC</label></div>
    <div class="input-field"><input type="text" id="agentPhone"><label>Phone</label></div>
    <div class="input-field"><select id="agentDistrict"></select><label>District</label></div>
  </div>
  <div class="modal-footer">
    <a href="#!" id="btnRegisterAgent" class="btn green">Register</a>
  </div>
</div>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  M.Modal.init(document.querySelectorAll('.modal'));
  M.FormSelect.init(document.querySelectorAll('select'));

  const { db, ref, get, update, child, onValue } = window._fb;
  function getCookie(name){ let m=document.cookie.match("(^|;)\\s*"+name+"\\s*=\\s*([^;]+)"); return m?m.pop():""; }
  const userId=getCookie("emaId");
  if(!userId){window.location.href="index.html";return;}

  // Load profile
  get(child(ref(db),"users/"+userId)).then(snap=>{
    if(snap.exists()){
      const u=snap.val();
      document.getElementById("profilePic").src=u.picBase64||"";
      document.getElementById("profileName").textContent=u.name;
      document.getElementById("profileEmail").textContent=u.email;

      if(u.agentId){
        document.getElementById("agentStatus").textContent="Agent Status: Agent ("+u.agentId+")";
        localStorage.setItem("agentId", u.agentId);
        document.cookie="agentId="+u.agentId+"; path=/";
        document.getElementById("agentButtonContainer").innerHTML='<a href="#!" id="btnUnregister" class="btn red">Unregister</a>';
        document.getElementById("btnUnregister").addEventListener("click",()=>{
          update(ref(db,"users/"+userId),{agentId:null,agentInfo:null}).then(()=>{
            localStorage.removeItem("agentId");
            document.cookie="agentId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
            location.reload();
          });
        });
      }else{
        document.getElementById("agentButtonContainer").innerHTML='<a href="#agentModal" class="btn modal-trigger green">Become Agent</a>';
        M.Modal.init(document.querySelectorAll('.modal'));
      }
      document.getElementById("editName").value=u.name||"";
      document.getElementById("editEmail").value=u.email||"";
      document.getElementById("editMobile").value=u.mobile||"";
      document.getElementById("editDistrict").value=u.district||"";
      M.updateTextFields(); M.FormSelect.init(document.querySelectorAll('select'));
    }
  });

  document.getElementById("btnRegisterAgent").addEventListener("click",async()=>{
    const agentId="EA-"+Math.floor(1000+Math.random()*9000);
    const info={name:document.getElementById("agentName").value,nic:document.getElementById("agentNIC").value,phone:document.getElementById("agentPhone").value,district:document.getElementById("agentDistrict").value};
    await update(ref(db,"users/"+userId),{agentId,agentInfo:info});
    localStorage.setItem("agentId",agentId);
    document.cookie="agentId="+agentId+"; path=/";
    location.reload();
  });

  document.getElementById("btnLogout").addEventListener("click",()=>{
    document.cookie="emaId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
    document.cookie="agentId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
    localStorage.clear(); sessionStorage.clear(); window.location.href="index.html";
  });

  // Live stats based on reports
  onValue(ref(db,"reports"),snap=>{
    if(snap.exists()){
      let elephants=0,reports=0,danger=0,deaths=0;
      snap.forEach(r=>{
        reports++;
        let data=r.val();
        if(data.elephantCount) elephants+=parseInt(data.elephantCount);
        if(data.danger==="High") danger++;
        if(data.incidentType==="Death") deaths++;
      });
      document.getElementById("statElephants").textContent=elephants;
      document.getElementById("statReports").textContent=reports;
      document.getElementById("statDanger").textContent=danger;
      document.getElementById("statDeaths").textContent=deaths;
    }
  });

  document.getElementById("profileCard").addEventListener("click",()=>M.Modal.getInstance(document.getElementById("editProfileModal")).open());
});
</script>
</body>
</html>
